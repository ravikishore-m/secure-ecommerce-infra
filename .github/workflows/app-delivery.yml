name: app-delivery

on:
  push:
    branches: [main]
    paths:
      - "services/**"
      - "frontend/**"
      - "k8s/**"
      - ".github/workflows/app-delivery.yml"
  pull_request:
    paths:
      - "services/**"
      - "frontend/**"
      - "k8s/**"
  workflow_dispatch:

permissions:
  id-token: write
  contents: read
  packages: write

env:
  AWS_REGION: us-east-1
  ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com

jobs:
  build-and-scan:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        component:
          - frontend
          - login
          - orders
          - payments
          - inventory
          - catalog
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Set component path
        run: |
          if [ "${{ matrix.component }}" = "frontend" ]; then
            echo "COMPONENT_PATH=frontend" >> $GITHUB_ENV
          else
            echo "COMPONENT_PATH=services/${{ matrix.component }}" >> $GITHUB_ENV
          fi
      - name: Install dependencies
        run: npm install
        working-directory: ${{ env.COMPONENT_PATH }}
      - name: Run tests (if present)
        run: npm test --if-present
        working-directory: ${{ env.COMPONENT_PATH }}
      - name: Build artifact
        run: npm run build --if-present
        working-directory: ${{ env.COMPONENT_PATH }}
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_APP_DEPLOY_ROLE }}
          aws-region: ${{ env.AWS_REGION }}
      - uses: aws-actions/amazon-ecr-login@v2
        id: ecr
      - uses: docker/setup-buildx-action@v3
      - name: Build and push image
        uses: docker/build-push-action@v5
        with:
          context: ${{ env.COMPONENT_PATH }}
          push: true
          provenance: true
          tags: |
            ${{ env.ECR_REGISTRY }}/ecom-${{ matrix.component }}:${{ github.sha }}
            ${{ env.ECR_REGISTRY }}/ecom-${{ matrix.component }}:latest
      - name: Trivy Scan
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: ${{ env.ECR_REGISTRY }}/ecom-${{ matrix.component }}:${{ github.sha }}
          format: table
          exit-code: "1"
          vuln-type: "os,library"
      - name: Generate SBOM
        uses: anchore/sbom-action@v0
        with:
          image: ${{ env.ECR_REGISTRY }}/ecom-${{ matrix.component }}:${{ github.sha }}
      - name: Install Cosign
        uses: sigstore/cosign-installer@v3
      - name: Sign image
        run: cosign sign --yes ${{ env.ECR_REGISTRY }}/ecom-${{ matrix.component }}:${{ github.sha }}
        env:
          COSIGN_EXPERIMENTAL: "true"

  deploy:
    needs: build-and-scan
    runs-on: ubuntu-22.04
    environment: prod
    steps:
      - uses: actions/checkout@v4
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_APP_DEPLOY_ROLE }}
          aws-region: ${{ env.AWS_REGION }}
      - name: Update kubeconfig
        run: aws eks update-kubeconfig --name prod-eks --region $AWS_REGION
      - name: Helm upgrade
        run: |
          helm upgrade --install ecommerce k8s/helm/platform-chart \
            --namespace ecommerce --create-namespace \
            --set global.imageRegistry=${{ env.ECR_REGISTRY }} \
            --set-string ingress.annotations.\"alb\\.ingress\\.kubernetes\\.io/wafv2-acl-arn\"=${{ secrets.WAF_ARN }} \
            --set-string ingress.annotations.\"alb\\.ingress\\.kubernetes\\.io/security-groups\"=${{ secrets.INGRESS_SG }}

